<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .stat-card {
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- å¤´éƒ¨ -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5">ğŸ“¦ å•†å“æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</h1>
                <p class="text-muted">ç®¡ç†æ‚¨çš„å•†å“æ•°æ®ï¼Œæ”¯æŒå¯¼å…¥ã€æŸ¥è¯¢ã€å¯¼å‡ºåŠŸèƒ½</p>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="row mb-4" id="stats-container">
            <!-- åŠ¨æ€åŠ è½½ç»Ÿè®¡ä¿¡æ¯ -->
        </div>

        <!-- æŸ¥è¯¢å’Œæ“ä½œåŒºåŸŸ -->
        <div class="row">
            <!-- å·¦ä¾§ï¼šæŸ¥è¯¢å’Œæ·»åŠ  -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">ğŸ” æŸ¥è¯¢å•†å“</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">å•†å“åç§°</label>
                            <input type="text" class="form-control" id="search-name" placeholder="è¾“å…¥å•†å“åç§°...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å•†å“åˆ†ç±»</label>
                            <select class="form-select" id="search-category">
                                <option value="">æ‰€æœ‰åˆ†ç±»</option>
                                <!-- åˆ†ç±»é€‰é¡¹åŠ¨æ€åŠ è½½ -->
                            </select>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">æœ€ä½ä»·æ ¼</label>
                                <input type="number" class="form-control" id="min-price" placeholder="0">
                            </div>
                            <div class="col">
                                <label class="form-label">æœ€é«˜ä»·æ ¼</label>
                                <input type="number" class="form-control" id="max-price" placeholder="10000">
                            </div>
                        </div>
                        <button class="btn btn-primary w-100" onclick="searchProducts()">æœç´¢</button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">â• æ·»åŠ å•†å“</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">å•†å“åç§° *</label>
                            <input type="text" class="form-control" id="add-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å•†å“åˆ†ç±» *</label>
                            <input type="text" class="form-control" id="add-category" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ä»·æ ¼ *</label>
                            <input type="number" step="0.01" class="form-control" id="add-price" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ¥æºURL</label>
                            <input type="url" class="form-control" id="add-url">
                        </div>
                        <button class="btn btn-success w-100" onclick="addProduct()">æ·»åŠ å•†å“</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">ğŸ“ æ•°æ®ç®¡ç†</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">å¯¼å…¥JSONæ–‡ä»¶</label>
                            <input type="file" class="form-control" id="import-file" accept=".json">
                        </div>
                        <button class="btn btn-info w-100 mb-3" onclick="importData()">å¯¼å…¥æ•°æ®</button>
                        
                        <label class="form-label">å¯¼å‡ºæ•°æ®æ ¼å¼</label>
                        <select class="form-select mb-3" id="export-format">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                        </select>
                        <button class="btn btn-warning w-100" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå•†å“åˆ—è¡¨å’Œå›¾è¡¨ -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“‹ å•†å“åˆ—è¡¨</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="products-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>åç§°</th>
                                        <th>åˆ†ç±»</th>
                                        <th>ä»·æ ¼</th>
                                        <th>æ·»åŠ æ—¶é—´</th>
                                    </tr>
                                </thead>
                                <tbody id="products-body">
                                    <!-- åŠ¨æ€åŠ è½½å•†å“æ•°æ® -->
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center" id="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h6>ğŸ“Š å•†å“åˆ†ç±»åˆ†å¸ƒ</h6>
                            <div id="category-chart"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h6>ğŸ’° ä»·æ ¼åˆ†å¸ƒ</h6>
                            <div id="price-chart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadCategories();
            loadProducts();
            loadCharts();
        });

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStatistics() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                const statsHtml = `
                    <div class="col-md-3">
                        <div class="card stat-card bg-primary text-white">
                            <div class="card-body text-center">
                                <h1 class="display-6">${stats.total_products}</h1>
                                <p class="mb-0">æ€»å•†å“æ•°</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-success text-white">
                            <div class="card-body text-center">
                                <h1 class="display-6">${stats.total_categories}</h1>
                                <p class="mb-0">åˆ†ç±»æ•°é‡</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-info text-white">
                            <div class="card-body text-center">
                                <h1 class="display-6">Â¥${stats.avg_price.toFixed(2)}</h1>
                                <p class="mb-0">å¹³å‡ä»·æ ¼</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-warning text-white">
                            <div class="card-body text-center">
                                <h1 class="display-6">Â¥${stats.min_price} - Â¥${stats.max_price}</h1>
                                <p class="mb-0">ä»·æ ¼èŒƒå›´</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('stats-container').innerHTML = statsHtml;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½åˆ†ç±»é€‰é¡¹
        async function loadCategories() {
            try {
                const products = await fetch('/api/products').then(r => r.json());
                const categories = [...new Set(products.map(p => p.category))].sort();
                
                const categorySelect = document.getElementById('search-category');
                categorySelect.innerHTML = '<option value="">æ‰€æœ‰åˆ†ç±»</option>';
                
                categories.forEach(category => {
                    if (category) {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
            }
        }

        // æœç´¢å•†å“
        async function searchProducts() {
            const name = document.getElementById('search-name').value;
            const category = document.getElementById('search-category').value;
            const minPrice = document.getElementById('min-price').value;
            const maxPrice = document.getElementById('max-price').value;
            
            let url = `/api/products?`;
            if (name) url += `name=${encodeURIComponent(name)}&`;
            if (category) url += `category=${encodeURIComponent(category)}&`;
            if (minPrice) url += `min_price=${minPrice}&`;
            if (maxPrice) url += `max_price=${maxPrice}`;
            
            await loadProducts(url);
        }

        // åŠ è½½å•†å“æ•°æ®
        async function loadProducts(apiUrl = '/api/products') {
            const loadingSpinner = document.getElementById('loading-spinner');
            const productsBody = document.getElementById('products-body');
            
            loadingSpinner.style.display = 'block';
            productsBody.innerHTML = '';
            
            try {
                const response = await fetch(apiUrl);
                const products = await response.json();
                
                if (products.length === 0) {
                    productsBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                æš‚æ— å•†å“æ•°æ®
                            </td>
                        </tr>
                    `;
                } else {
                    productsBody.innerHTML = products.map(product => `
                        <tr>
                            <td>${product.id}</td>
                            <td>${product.name}</td>
                            <td><span class="badge bg-secondary">${product.category}</span></td>
                            <td class="text-success fw-bold">Â¥${product.price?.toFixed(2) || '0.00'}</td>
                            <td>${new Date(product.created_at).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                }
                
                loadCharts(); // é‡æ–°åŠ è½½å›¾è¡¨
                
            } catch (error) {
                console.error('åŠ è½½å•†å“å¤±è´¥:', error);
                productsBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger py-4">
                            åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•
                        </td>
                    </tr>
                `;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        // æ·»åŠ å•†å“
        async function addProduct() {
            const name = document.getElementById('add-name').value;
            const category = document.getElementById('add-category').value;
            const price = document.getElementById('add-price').value;
            const url = document.getElementById('add-url').value;
            
            if (!name || !category || !price) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼');
                return;
            }
            
            try {
                const response = await fetch('/api/add_product', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        category: category,
                        price: parseFloat(price),
                        source_url: url
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('å•†å“æ·»åŠ æˆåŠŸï¼');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('add-name').value = '';
                    document.getElementById('add-category').value = '';
                    document.getElementById('add-price').value = '';
                    document.getElementById('add-url').value = '';
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    loadProducts();
                    loadStatistics();
                    loadCategories();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('æ·»åŠ å•†å“å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            }
        }

        // å¯¼å…¥æ•°æ®
        async function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©JSONæ–‡ä»¶ï¼');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/import', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    fileInput.value = '';
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    loadProducts();
                    loadStatistics();
                    loadCategories();
                } else {
                    alert('å¯¼å…¥å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const format = document.getElementById('export-format').value;
            window.open(`/api/export?format=${format}`, '_blank');
        }

        // åŠ è½½å›¾è¡¨
        async function loadCharts() {
            try {
                const response = await fetch('/api/chart');
                const chartData = await response.json();
                
                if (chartData.category_chart) {
                    const categoryChart = JSON.parse(chartData.category_chart);
                    Plotly.newPlot('category-chart', categoryChart.data, categoryChart.layout);
                }
                
                if (chartData.price_chart) {
                    const priceChart = JSON.parse(chartData.price_chart);
                    Plotly.newPlot('price-chart', priceChart.data, priceChart.layout);
                }
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>